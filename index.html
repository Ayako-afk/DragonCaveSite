<script>
  let dragons = [];

  async function fetchDragons() {
    const username = document.getElementById('username').value;
    const response = await fetch(`https://dragcave.net/api/user/${username}`);
    const xmlText = await response.text();

    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, "application/xml");
    const creatures = xml.querySelectorAll("dragon");

    dragons = Array.from(creatures).filter(d => {
      const stage = d.getAttribute("stage");
      return stage === "egg" || stage === "hatchling";
    });

    displayDragons();
  }

  function displayDragons() {
    const container = document.getElementById("dragons");
    container.innerHTML = "";

    dragons.forEach((dragon, index) => {
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = `dragon-${index}`;
      checkbox.dataset.index = index;

      const label = document.createElement("label");
      label.htmlFor = `dragon-${index}`;
      label.innerText = `${dragon.getAttribute("name") || "Unnamed"} (${dragon.getAttribute("stage")})`;

      container.appendChild(checkbox);
      container.appendChild(label);
      container.appendChild(document.createElement("br"));
    });

    const submitBtn = document.createElement("button");
    submitBtn.innerText = "Add Selected to Pool";
    submitBtn.onclick = submitToPool;
    container.appendChild(submitBtn);
  }

  async function submitToPool() {
    const selected = Array.from(document.querySelectorAll("input[type=checkbox]:checked"))
      .map(cb => dragons[cb.dataset.index])
      .map(d => ({
        id: d.getAttribute("id"),
        name: d.getAttribute("name"),
        stage: d.getAttribute("stage"),
        breed: d.getAttribute("breed"),
        owner: document.getElementById("username").value
      }));

    const response = await fetch("/api/add-to-pool", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(selected)
    });

    const result = await response.json();
    alert(result.message || "Dragons added!");
  }

  async function showRandomPool() {
    const response = await fetch("/api/random-pool");
    const pool = await response.json();

    const container = document.getElementById("dragons");
    container.innerHTML = "<h2>Random Dragons from the Pool</h2>";

    pool.forEach(d => {
      const div = document.createElement("div");
      div.innerText = `${d.name || "Unnamed"} (${d.stage}) - ${d.breed}`;
      container.appendChild(div);
    });
  }
</script>

